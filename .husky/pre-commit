#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ›¡ï¸  CyberShield-IronCore: Enforcing Enterprise Quality Gates ğŸ›¡ï¸"
echo "=========================================================="

# NON-NEGOTIABLE Quality Gates - MUST PASS BEFORE COMMIT

echo "ğŸ” Step 1: ESLint Check (Zero errors/warnings allowed)"
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint failed! Fix all errors and warnings before committing."
  exit 1
fi
echo "âœ… ESLint passed!"

echo ""
echo "ğŸ”§ Step 2: TypeScript Type Check (Zero errors allowed)"
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type check failed! Fix all type errors before committing."
  exit 1
fi
echo "âœ… TypeScript type check passed!"

echo ""
echo "ğŸ§ª Step 3: Test Suite (100% pass rate required)"
npm run test
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed! All tests must pass before committing."
  exit 1
fi
echo "âœ… All tests passed!"

echo ""
echo "ğŸ“Š Step 4: Test Coverage (100% coverage required)"
npm run test:coverage
if [ $? -ne 0 ]; then
  echo "âŒ Test coverage below 100%! Add tests to achieve full coverage."
  exit 1
fi
echo "âœ… 100% test coverage achieved!"

echo ""
echo "ğŸ—ï¸  Step 5: Production Build (Must succeed)"
npm run build
if [ $? -ne 0 ]; then
  echo "âŒ Production build failed! Fix all build errors before committing."
  exit 1
fi
echo "âœ… Production build successful!"

echo ""
echo "ğŸ”’ Step 6: Security Audit (No high/critical vulnerabilities)"
npm run security:audit
if [ $? -ne 0 ]; then
  echo "âŒ Security vulnerabilities detected! Run 'npm audit fix' to resolve."
  exit 1
fi
echo "âœ… Security audit passed!"

echo ""
echo "ğŸ’ Step 7: Code Formatting (Prettier)"
npm run format:check
if [ $? -ne 0 ]; then
  echo "âŒ Code formatting issues detected! Run 'npm run format' to fix."
  exit 1
fi
echo "âœ… Code formatting verified!"

echo ""
echo "ğŸ‰ ALL QUALITY GATES PASSED! ğŸ‰"
echo "Enterprise-grade code ready for commit."
echo "Iron Man would be proud! ğŸ¤–âš¡"
echo "========================================"